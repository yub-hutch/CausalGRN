% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/infer_causalgrn.R
\name{infer_causalgrn}
\alias{infer_causalgrn}
\title{Direct edges using perturbation effect}
\usage{
infer_causalgrn(
  graph,
  stat,
  alpha,
  conservative = TRUE,
  max_order = 1,
  max_dist = Inf,
  evidence = 1
)
}
\arguments{
\item{graph}{Initial igraph object.}

\item{stat}{Perturbation effect from \code{\link{calc_perturbation_effect}}.}

\item{alpha}{Numeric representing DE Q-value threshold.}

\item{conservative}{Logical indicating whether to make conservative inference (Default is \code{TRUE}).}

\item{max_order}{Integer representing the maximum order for DE descendant inference. Can be 1 or 2. Default is 1.}

\item{max_dist}{Integer representing the maximum distance allowed for a perturbed gene to cause DE on another gene. Ignore for `max_order = 1`. Default is Inf.}

\item{evidence}{Integer representing number of evidences needed for second-order orientation. Ignore for `max_order = 1`. Default is 1.}
}
\value{
igraph object.
}
\description{
Infers causal GRN by directing edges based on differential expression caused by perturbations.
}
\examples{
# --- 0. SETUP: Load Libraries & Define Ground Truth ---
library(dplyr)
library(igraph)
library(CausalGRN)

# Define all simulation parameters upfront
a <- b <- 1
sd <- 2
s <- -4
nwt <- 1e5 # User-specified WT sample size
npt <- 1e4 # User-specified perturbed sample size
ko_efficacy <- 0.9 # 90\% knockdown efficiency

# Define the ground truth graph for this simulation
ground_truth <- igraph::make_graph(~ A -+ B, B -+ C)
E(ground_truth)$weight <- c(a, b)

# --- 1. DATA SIMULATION: Create the Toy Example ---
set.seed(123)

# Generate Wild-Type (WT) Data
x_latent_wt <- rnorm(nwt, 0, sd)
y_latent_wt <- rnorm(nwt, a * x_latent_wt + s, sd)
z_latent_wt <- rnorm(nwt, b * (y_latent_wt - s), sd)
wt_counts <- cbind(
  X = rpois(nwt, exp(x_latent_wt)),
  Y = rpois(nwt, exp(y_latent_wt)),
  Z = rpois(nwt, exp(z_latent_wt))
)
colMeans(wt_counts == 0)

# Generate Perturb-X Data (independent population)
x_latent_template_koX <- rnorm(npt, 0, sd)
x_latent_final_koX <- x_latent_template_koX + log(1 - ko_efficacy)
y_latent_final_koX <- rnorm(npt, a * x_latent_final_koX + s, sd)
z_latent_final_koX <- rnorm(npt, b * (y_latent_final_koX - s), sd)
koX_counts <- cbind(
  X = rpois(npt, exp(x_latent_final_koX)),
  Y = rpois(npt, exp(y_latent_final_koX)),
  Z = rpois(npt, exp(z_latent_final_koX))
)
colMeans(koX_counts == 0)

# --- 2. PREPARE INPUTS for GRN Methods ---
count <- rbind(wt_counts, koX_counts)
group <- factor(c(rep('WT', nwt), rep('A', npt)))
Y <- scale(log1p(count), center = TRUE, scale = TRUE)
colnames(count) <- colnames(Y) <- c('A', 'B', 'C')
wt <- Y[group == 'WT', ]
pts <- list(
  A = Y[group == 'A', ]
)

# --- 3. RUN GRN INFERENCE METHODS ---
cat("Running GRN inference methods...\n")

# Your method: CausalGRN (uses perturbation data)
skel <- infer_skeleton(count, Y, alpha = 0.05, min_abspcor = 0, ncores = 1)
stat <- calc_perturbation_effect(Y, group, ncores = 1)
graph_cgrn <- infer_causalgrn(skel$graph, stat, alpha = 0.05, max_order = 2)

plot(graph_cgrn)

}
